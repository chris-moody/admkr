/*!
 * VERSION: 0.0.1
 * DATE: 2019-10-28
 * UPDATES AND DOCS AT: https://chris-moody.github.io/mkr
 *
 * @license copyright 2019 Christopher C. Moody
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy of
 *  this software and associated documentation files (the "Software"), to deal in the
 *  Software without restriction, including without limitation the rights to use, copy,
 *  modify, merge, publish, distribute, sublicense, and/or sell copies of the Software,
 *  and to permit persons to whom the Software is furnished to do so, subject to the
 *  following conditions:
 *
 *  The above copyright notice and this permission notice shall be included in all
 *  copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 *  INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 *  PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 *  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 *  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 *  SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 * 
 * @author: Christopher C. Moody, chris@moodydigital.com
 */
!function(global){var _instances={},_count=-1,scrllbr=function(options){_count++;var id=this._id=(options=options||{}).id||"scrllbr-"+_count;this._parent=mkr.getDefault(options,"parent",document.body),mkr.setDefault(options,"attr",{}),mkr.setDefault(options.attr,"id",id),mkr.setDefault(options.attr,"class","mkr-scrllbr"),mkr.setDefault(options,"css",{}),mkr.setDefault(options,"track",{}),mkr.setDefault(options.track,"attr",{}),mkr.setDefault(options.track.attr,"class","track"),mkr.setDefault(options.track,"css",{}),mkr.setDefault(options,"thumb",{}),mkr.setDefault(options.thumb,"attr",{}),mkr.setDefault(options.thumb.attr,"class","thumb"),mkr.setDefault(options.thumb,"css",{}),mkr.setDefault(options.thumb.css,"height",100),this._container=mkr.create("div",{attr:options.attr,css:options.css},this._parent),this._track=mkr.create("div",options.track,this._container),this._thumb=mkr.create("div",options.thumb,this._container),this._ux=mkr.setDefault(options,"ux","click"),this._observer=new MutationObserver(this.onMutate.bind(this)),this._scrolling=!1,this._scroll=0,this._range=0,this._touchStart={x:0,y:0},this.type=mkr.setDefault(options,"type",scrllbr.VERTICAL),this.target=mkr.setDefault(options,"target",null),_instances[id]=this};scrllbr.prototype={get el(){return this._container},get range(){return this.type===scrllbr.VERTICAL?this._track.clientHeight-this._thumb.clientHeight:this._track.clientWidth-this._thumb.clientWidth},get scroll(){return this._scroll},set scroll(value){this._scroll=Math.min(1,Math.max(0,value)),this.type===scrllbr.VERTICAL?TweenMax.set(this._thumb,{y:this._scroll*this.range}):TweenMax.set(this._thumb,{x:this._scroll*this.range})},get target(){return this._target},set target(value){this._target&&this.removeListeners(),this._target=value,this._target&&(this.addListeners(),mkr.once(window,"load",this.refresh,this))},get type(){return this._type},set type(value){this._type=value,this._type===scrllbr.VERTICAL?TweenMax.set(this._container,{className:"-=horizontal"}):TweenMax.set(this._container,{className:"+=horizontal"})},addListeners:function(){if(mkr.on(this._target,"scroll",this.onScroll,this),this._ux.indexOf("touch")<0)return mkr.on(this._thumb,"mousedown",this.startScroll,this),void mkr.on(this._track,"mousedown",this.trackScroll,this);mkr.on(this._thumb,"touchstart",this.startScroll,this),mkr.on(this._track,"touchstart",this.trackScroll,this)},removeListeners:function(){if(this._scrolling=!1,mkr.off(this._target,"scroll",this.onScroll,this),this._ux.indexOf("touch")<0)return mkr.off(this._thumb,"mousedown",this.startScroll,this),mkr.off(this._track,"mousedown",this.trackScroll,this),mkr.off(document.body,"mouseup",this.stopScroll,this),mkr.off(document.body,"mouseleave",this.stopScroll,this),void mkr.off(document.body,"mousemove",this.updateScroll,this);mkr.off(this._thumb,"touchstart",this.startScroll,this),mkr.off(this._track,"touchstart",this.trackScroll,this),mkr.off(document.body,"touchend",this.stopScroll,this),mkr.off(document.body,"touchcancel",this.stopScroll,this),mkr.off(document.body,"touchmove",this.updateScroll,this)},trackScroll:function(e){for(var delta,dir,sLen,eX,eY,target=this._target,x=0,y=0,t=this._container;t.offsetParent;)x+=t.offsetLeft,y+=t.offsetTop,t=t.offsetParent;eY="touchstart"===e.type?(eX=(eY=e.touches[0]).clientX,eY.clientY):(eX=e.clientX,e.clientY),delta=this.type===scrllbr.VERTICAL?(delta=(eY-y)/this.range-this.scroll,dir=Math.abs(delta)/delta,sLen=target.scrollHeight-target.clientHeight,.95*dir*(target.clientHeight/sLen)):(delta=(eX-x)/this.range-this.scroll,dir=Math.abs(delta)/delta,sLen=target.scrollWidth-target.clientWidth,.95*dir*(target.clientWidth/sLen)),this.scroll=this._scroll+delta,TweenMax.set(this._target,{scrollTo:this.scroll*sLen}),this.startScroll(e)},startScroll:function(touch){if(this._scrolling=!0,"touchstart"===touch.type&&(touch=touch.touches[0],this._touchStart={x:touch.clientX,y:touch.clientY}),this._ux.indexOf("touch")<0)return mkr.on(document.body,"mouseup",this.stopScroll,this),mkr.on(document.body,"mouseleave",this.stopScroll,this),void mkr.on(document.body,"mousemove",this.updateScroll,this);mkr.on(document.body,"touchend",this.stopScroll,this),mkr.on(document.body,"touchcancel",this.stopScroll,this),mkr.on(document.body,"touchmove",this.updateScroll,this)},stopScroll:function(e){if(this._scrolling=!1,this._touchStart={x:0,y:0},this._ux.indexOf("touch")<0)return mkr.off(document.body,"mouseup",this.stopScroll,this),mkr.off(document.body,"mouseleave",this.stopScroll,this),void mkr.off(document.body,"mousemove",this.updateScroll,this);mkr.off(document.body,"touchend",this.stopScroll,this),mkr.off(document.body,"touchcancel",this.stopScroll,this),mkr.off(document.body,"touchmove",this.updateScroll,this)},updateScroll:function(e){var sLen,delta,touch,target=this._target;"touchmove"==e.type&&(touch=e.changedTouches[0]),this.type===scrllbr.VERTICAL?(sLen=target.scrollHeight-target.clientHeight,"touchmove"==e.type?(delta=(touch.clientY-this._touchStart.y)/this.range,this._touchStart.y=touch.clientY):delta=e.movementY/this.range):(sLen=target.scrollWidth-target.clientWidth,"touchmove"==e.type?(delta=(touch.clientX-this._touchStart.x)/this.range,this._touchStart.x=touch.clientX):delta=movementX/this.range),this.scroll=this._scroll+delta,TweenMax.set(this._target,{scrollTo:(this.scroll+delta)*sLen})},onScroll:function(e){var sPos,target;this._scrolling||(target=this._target)&&(sPos=this.type===scrllbr.VERTICAL?(sPos=target.scrollHeight-target.clientHeight,target.scrollTop/sPos):(sPos=target.scrollWidth-target.clientWidth,target.scrollLeft/sPos),this.scroll=sPos)},onMutate:function(mutationsList,observer){mutationsList.forEach(function(mutation){"childList"===mutation.type&&this.refresh()})},refresh:function(){var sLength,sPos,sRatio,target=this._target;target&&(this.type===scrllbr.VERTICAL?(sLength=target.scrollHeight-target.clientHeight,sRatio=target.clientHeight/target.scrollHeight,sPos=target.scrollTop/sLength,TweenMax.set(this._thumb,{height:sRatio*this._track.clientHeight})):(sLength=target.scrollWidth-target.clientWidth,sRatio=target.clientWidth/target.scrollWidth,sPos=target.scrollLeft/sLength,TweenMax.set(this._thumb,{width:sRatio*this._track.clientWidth})),this.scroll=sPos)}},Object.defineProperty(scrllbr,"VERTICAL",{get:function(){return"vertical"}}),Object.defineProperty(scrllbr,"HORIZONTAL",{get:function(){return"horizontal"}}),scrllbr.getInstance=function(id){return _instances[id]},scrllbr.getElInstance=function(el){return _instances[el.id]},Object.defineProperty(scrllbr,"VERSION",{get:function(){return"0.0.1"}}),"function"==typeof define&&define.amd?define(function(){return scrllbr}):"undefined"!=typeof module&&module.exports?module.exports=scrllbr:global.scrllbr=scrllbr}(mkr._constructs);